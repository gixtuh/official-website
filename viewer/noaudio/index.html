<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>remote controller</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #cursor { position: absolute; width: 14px; height: 14px; border: 2px solid white; border-radius: 50%; pointer-events: none; background: rgba(255,255,255,0.4); z-index: 9999; }
        #typeBox {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 60vw; padding: 8px; border-radius: 6px; border: none;
            background: rgba(255,255,255,0.18); color: white; outline: none; font-size: 14px;
        }
        #sendText {
            position: absolute; bottom: 10px; right: calc(20vw - 75px);
            padding: 8px 12px; border-radius: 6px; border: none;
            background: #33aa33; cursor: pointer; color: black; font-weight: bold;
        }
        #copyBtn {
            position: absolute; bottom: 10px; right: calc(20vw - 145px);
            padding: 8px 12px; border-radius: 6px; border: none;
            background: #2baac0; cursor: pointer; color: black; font-weight: bold;
        }
        #sendText:hover { background: #44cc44; }
        #copyBtn:hover { background: #0b778a; }
    </style>
</head>
<body>
    <canvas id="screen"></canvas>
    <div id="cursor"></div>
    <input id="typeBox" placeholder="fast type to vnc">
    <button id="sendText">SEND</button>
    <button id="copyBtn">COPY</button>
    
    
    <script>
        function getParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        
        let baseURL = getParam("ws");
        let password = getParam("passwd");
        
        if (!baseURL) {
            baseURL = prompt("enter control websocket here");
        }
        if (!password) {
            password = prompt("enter password here");
        }
        const wsFrames = new WebSocket(baseURL, password);
        const wsInput  = new WebSocket(baseURL + "/input", password);
        
        wsFrames.binaryType = "arraybuffer";
        
        const canvas = document.getElementById("screen");
        const ctx = canvas.getContext("2d");
        const cursor = document.getElementById("cursor");
        let realW = 1, realH = 1;
        let drawRect = {x:0, y:0, w:0, h:0};
        
        function getRealMousePos(e){
            const mx = e.clientX, my = e.clientY;
            if(mx < drawRect.x || mx > drawRect.x + drawRect.w) return null;
            if(my < drawRect.y || my > drawRect.y + drawRect.h) return null;
            return {
                x: (mx - drawRect.x) * (realW / drawRect.w),
                y: (my - drawRect.y) * (realH / drawRect.h)
            };
        }
        
        let lastMousePos = null;
        
        setInterval(() => {
            if (lastMousePos) {
                wsInput.send(JSON.stringify({
                    type: "mouse",
                    x: lastMousePos.x,
                    y: lastMousePos.y,
                    move: true
                }));
                lastMousePos = null;
            }
        }, 300);
        
        canvas.addEventListener("mousemove", e => {
            const pos = getRealMousePos(e);
            if(!pos) return;
            lastMousePos = pos;
        });
        
        canvas.addEventListener("mousedown", e => {
            if (document.activeElement === typeBox) return;
            const pos = getRealMousePos(e); if(!pos) return;
            
            let btn = null;
            if (e.button === 0) btn = "left";
            if (e.button === 2) btn = "right";
            if (!btn) return;
            
            wsInput.send(JSON.stringify({type:"mouse", x:pos.x, y:pos.y, button:btn, state:"down"}));
        });
        
        canvas.addEventListener("mouseup", e => {
            if (document.activeElement === typeBox) return;
            const pos = getRealMousePos(e); if(!pos) return;
            
            let btn = null;
            if (e.button === 0) btn = "left";
            if (e.button === 2) btn = "right";
            if (!btn) return;
            
            wsInput.send(JSON.stringify({type:"mouse", x:pos.x, y:pos.y, button:btn, state:"up"}));
        });
        
        
        canvas.addEventListener("contextmenu", e => e.preventDefault());
        
        
        const img = new Image();
        wsFrames.onmessage = evt => {
            if (typeof evt.data === "string") {
                const data = JSON.parse(evt.data);
                
                if (data.type === "size") { 
                    realW = data.w; realH = data.h;
                }
                
                if (data.type === "cursor") {
                    const cx = drawRect.x + (data.x * (drawRect.w / realW));
                    const cy = drawRect.y + (data.y * (drawRect.h / realH));
                    
                    cursor.style.left = cx + "px";
                    cursor.style.top  = cy + "px";
                }
                
                return;
            }
            
            const blob = new Blob([evt.data], { type: "image/jpeg" });
            const url = URL.createObjectURL(blob);
            img.src = url;
            img.onload = () => {
                const cw = window.innerWidth, ch = window.innerHeight;
                canvas.width = cw; canvas.height = ch;
                const scale = Math.min(cw / realW, ch / realH);
                const w = realW * scale, h = realH * scale, x = (cw - w) / 2, y = (ch - h) / 2;
                drawRect = {x, y, w, h};
                ctx.drawImage(img, x, y, w, h);
                URL.revokeObjectURL(url);
            };
        };
        const typeBox  = document.getElementById("typeBox");
        const sendBtn  = document.getElementById("sendText");
        
        function sendType() {
            if (typeBox.value.trim() !== "") {
                wsInput.send(JSON.stringify({
                    type: "type",
                    text: typeBox.value
                }));
                typeBox.value = "";
            }
        }
        
        
        typeBox.addEventListener("keydown", (e) => {
            e.stopPropagation();
            if (e.key === "Enter") {
                e.preventDefault();
                sendType();
            }
        });
        
        sendBtn.addEventListener("click", sendType);
        document.getElementById("copyBtn").addEventListener("click", () => {
            alert("sent copy message to server, awaiting response...")
            wsInput.send(JSON.stringify({type:"clipboard", action:"get"}));
        });
        
        wsInput.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if(data.type === "clipboard"){
                alert("got response: " + data.text)
                navigator.clipboard.writeText(data.text)
                .then(() => console.log("Clipboard updated!"))
                .catch(err => console.error("Failed to write clipboard:", err));
            }
        };
        
        document.addEventListener("keydown", e => {
            e.preventDefault();
            if (document.activeElement === typeBox) return;
            wsInput.send(JSON.stringify({type:"keyboard", key:e.key, action:"down"}));
        });
        document.addEventListener("keyup", e => {
            if (document.activeElement === typeBox) return;
            wsInput.send(JSON.stringify({type:"keyboard", key:e.key, action:"up"}));
        });
    </script>
</body>
</html>
